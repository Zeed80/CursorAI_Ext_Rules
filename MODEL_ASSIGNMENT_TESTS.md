# Тесты для проверки назначения моделей агентам

## Проблема

VS Code Settings Tree не может обработать сложные объекты в настройках. При сохранении объекта `LanguageModelInfo` возникала ошибка:
```
TreeError [SettingsTree] Tree element not found: [object Object]
```

## Решение

Изменен способ сохранения моделей:
- **Раньше**: Сохранялся весь объект `LanguageModelInfo` в `agents.{agentId}.selectedModel`
- **Теперь**: Сохраняется только `modelId` (строка) в `agents.{agentId}.selectedModelId`

## Тесты для проверки

### Тест 1: Сохранение модели

```typescript
// 1. Выберите агента (например, Backend Developer)
// 2. Выберите команду "Select Model for Agent"
// 3. Выберите модель из списка
// 4. Проверьте, что модель сохранилась

// Ожидаемый результат:
// - В настройках VS Code (settings.json) должно быть:
//   "cursor-autonomous.agents": {
//     "backend": {
//       "selectedModelId": "gpt-4o"  // Только строка, не объект!
//     }
//   }
```

### Тест 2: Загрузка модели при инициализации

```typescript
// 1. Сохраните модель для агента (см. Тест 1)
// 2. Перезапустите VS Code
// 3. Проверьте, что агент загрузил сохраненную модель

// Ожидаемый результат:
// - Агент должен использовать сохраненную модель
// - В UI должно отображаться имя модели
```

### Тест 3: Автоматический выбор модели (auto mode)

```typescript
// 1. Выберите агента
// 2. Выберите команду "Select Model for Agent"
// 3. Выберите "Автоматический выбор"
// 4. Проверьте настройки

// Ожидаемый результат:
// - В настройках не должно быть selectedModelId для этого агента
// - Агент должен использовать автоматический выбор CursorAI
```

### Тест 4: Восстановление модели из modelId

```typescript
// 1. Сохраните модель для агента
// 2. Проверьте, что в настройках сохранен только modelId
// 3. Получите модель через getAgentModel()

// Ожидаемый результат:
// - getAgentModel() должен восстановить полный объект LanguageModelInfo
// - Если модель не найдена в доступных, должен вернуться минимальный объект с id
```

### Тест 5: Совместимость с VS Code Settings Tree

```typescript
// 1. Сохраните модель для нескольких агентов
// 2. Откройте настройки VS Code (Ctrl+,)
// 3. Найдите "Cursor Autonomous" настройки
// 4. Проверьте, что нет ошибок в консоли

// Ожидаемый результат:
// - Нет ошибок "Tree element not found: [object Object]"
// - Настройки отображаются корректно
// - Можно редактировать настройки вручную
```

## Ручные тесты

### Тест A: Выбор модели через UI

1. Откройте панель "Агенты" (CursorAI в боковой панели)
2. Правой кнопкой мыши на агенте → "Select Model for Agent"
3. Выберите модель из списка
4. Проверьте, что модель отображается в описании агента

### Тест B: Проверка сохранения в settings.json

1. Выберите модель для агента
2. Откройте `settings.json` (Ctrl+Shift+P → "Preferences: Open User Settings (JSON)")
3. Найдите `cursor-autonomous.agents`
4. Убедитесь, что сохранен только `selectedModelId` (строка), а не объект

### Тест C: Проверка работы после перезапуска

1. Сохраните модель для агента
2. Перезапустите VS Code
3. Проверьте, что агент использует сохраненную модель
4. Проверьте UI - модель должна отображаться

### Тест D: Автоматический выбор модели

1. Выберите "Автоматический выбор" для агента
2. Проверьте, что в настройках нет `selectedModelId`
3. Проверьте, что агент работает (использует автоматический выбор CursorAI)

## Проверка через код

### Проверка сохранения

```typescript
const config = vscode.workspace.getConfiguration('cursor-autonomous');
const agentsConfig = config.get<{ [key: string]: { selectedModelId?: string } }>('agents', {});

// Проверка: должен быть только selectedModelId (строка)
console.assert(typeof agentsConfig['backend']?.selectedModelId === 'string');
console.assert(agentsConfig['backend']?.selectedModel === undefined);
```

### Проверка загрузки

```typescript
const settingsManager = new SettingsManager();
const model = await settingsManager.getAgentModel('backend');

// Проверка: должен быть восстановлен полный объект
console.assert(model !== undefined);
console.assert(model?.id !== undefined);
```

## Известные проблемы и решения

### Проблема: Ошибка "Tree element not found: [object Object]"

**Причина**: Сохранение сложного объекта в настройках VS Code

**Решение**: Сохранять только примитивные значения (строки, числа, булевы)

### Проблема: Модель не загружается после перезапуска

**Причина**: Модель не найдена в доступных моделях

**Решение**: Метод `getAgentModel()` возвращает минимальный объект с `id`, если модель не найдена

### Проблема: Модель не применяется к агенту

**Причина**: Фоновый агент CursorAI не обновлен

**Решение**: После сохранения модели вызывается `CursorAPI.createOrUpdateBackgroundAgent()` с новым `modelId`

## Логирование

Для отладки включите логирование в консоли разработчика:

```typescript
// В консоли VS Code (Help → Toggle Developer Tools)
// Ищите сообщения:
// - "Using saved model {modelId} for agent {agentId}"
// - "No saved model for agent {agentId}, using auto mode"
// - "v0 Agent {backgroundAgentId} model updated to {modelId}"
```

## Чек-лист перед релизом

- [ ] Тест A: Выбор модели через UI работает
- [ ] Тест B: Сохранение в settings.json корректно (только строка)
- [ ] Тест C: Модель загружается после перезапуска
- [ ] Тест D: Автоматический выбор работает
- [ ] Нет ошибок в консоли VS Code
- [ ] Настройки отображаются в Settings UI без ошибок
- [ ] Фоновые агенты CursorAI создаются/обновляются с правильной моделью
