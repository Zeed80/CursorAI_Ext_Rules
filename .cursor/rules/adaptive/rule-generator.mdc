---
name: Rule Generator
description: Генератор адаптивных правил на основе анализа кодовой базы
globs: ["**/*"]
alwaysApply: false
---

# Генератор адаптивных правил

**Твоя роль**: Система генерации правил для проекта на основе анализа кодовой базы

## Процесс:

### 1. Анализ проекта

**Используй следующие инструменты**:

1. **`codebase_search`** - для поиска паттернов:
   - "Как организована структура проекта?"
   - "Какие паттерны проектирования используются?"
   - "Как обрабатываются ошибки?"
   - "Как организована работа с базой данных?"

2. **`grep`** - для поиска специфичных паттернов:
   - Поиск импортов/использования библиотек
   - Поиск стиля именования (camelCase, snake_case, PascalCase)
   - Поиск паттернов обработки ошибок (try-catch, error handling)

3. **`read_file`** - для чтения конфигурационных файлов:
   - `package.json`, `composer.json`, `requirements.txt`
   - Конфигурации линтеров (`.eslintrc`, `.php_cs`, `pyproject.toml`)
   - Конфигурации тестов (`phpunit.xml`, `jest.config.js`)

4. **`list_dir`** - для изучения структуры:
   - Структура директорий
   - Организация модулей
   - Разделение на слои (controllers, models, services)

**Определи**:
- Технологический стек (языки, фреймворки, библиотеки)
- Стиль кода (naming conventions, структура)
- Архитектурные паттерны (MVC, Clean Architecture, etc.)
- Паттерны обработки ошибок
- Паттерны работы с данными (ORM, Repository, etc.)

### 2. Генерация правил

**Создай правила на основе найденных паттернов**:

#### Для PHP проектов:

```markdown
---
name: PHP Project Rules
description: Правила для PHP проекта на основе анализа
globs: ["**/*.php"]
alwaysApply: true
---

# PHP Правила проекта

## Стиль кода
- Соблюдение PSR-12
- Типизация параметров и возвращаемых значений
- Strict mode: declare(strict_types=1);

## Паттерны проекта
[Найденные паттерны из анализа]

## Примеры из проекта
[Примеры кода из кодовой базы]
```

#### Для JavaScript/TypeScript проектов:

```markdown
---
name: JavaScript Project Rules
description: Правила для JavaScript проекта
globs: ["**/*.js", "**/*.ts", "**/*.jsx", "**/*.tsx"]
alwaysApply: true
---

# JavaScript Правила проекта

## Стиль кода
- Использовать const/let, избегать var
- Arrow functions для callbacks
- Async/await вместо Promises

## Паттерны проекта
[Найденные паттерны]
```

#### Для Python проектов:

```markdown
---
name: Python Project Rules
description: Правила для Python проекта
globs: ["**/*.py"]
alwaysApply: true
---

# Python Правила проекта

## Стиль кода
- Соблюдение PEP 8
- Type hints для функций
- Docstrings для модулей и функций

## Паттерны проекта
[Найденные паттерны]
```

### 3. Адаптация существующих правил

**Адаптируй общие правила под проект**:

1. **Читай существующие правила** из `.cursor/rules/`
2. **Анализируй проект** для определения специфики
3. **Адаптируй правила**:
   - Добавь примеры из проекта
   - Уточни паттерны под используемые технологии
   - Добавь специфичные для проекта правила

**Пример адаптации**:

**До** (общее правило):
```markdown
# Обработка ошибок
Используй try-catch для обработки ошибок
```

**После** (адаптированное):
```markdown
# Обработка ошибок
Используй try-catch для обработки ошибок.

Пример из проекта:
```php
try {
    $book = $this->repository->findById($id);
    if (!$book) {
        throw new NotFoundException("Book not found");
    }
    return $book;
} catch (NotFoundException $e) {
    error_log("Book not found: " . $e->getMessage());
    throw $e;
}
```
```

### 4. Добавление специфичных правил

**Создай правила на основе уникальных паттернов проекта**:

1. **Найди уникальные паттерны** через `codebase_search`
2. **Создай правила** для этих паттернов
3. **Добавь примеры** из кодовой базы

**Примеры специфичных правил**:

- Правила работы с конкретной ORM (Eloquent, Doctrine, SQLAlchemy)
- Правила работы с конкретным фреймворком (Laravel, React, Django)
- Правила работы с конкретными библиотеками проекта
- Правила именования, специфичные для проекта

### 5. Проверка через MCP Context7

**Перед сохранением правил**:

1. **Проверь синтаксис** через MCP Context7:
   - Для PHP: проверь функции, классы, синтаксис
   - Для JavaScript: проверь ES2023 синтаксис
   - Для Python: проверь PEP 8 соответствие

2. **Проверь актуальность**:
   - Версии библиотек
   - Best practices
   - Устаревшие паттерны

### 6. Оптимизация

**После генерации правил**:

1. **Удали дублирующиеся правила**
2. **Объедини похожие правила**
3. **Оптимизируй для уменьшения контекста**:
   - Сожми длинные объяснения
   - Сохрани только важные примеры
   - Используй ссылки на другие правила

4. **Сохрани важную информацию**:
   - Критичные правила → полный текст
   - Важные правила → сжатый текст
   - Справочные правила → ссылки

## Формат правил:

```markdown
---
name: [Название правила]
description: [Описание]
globs: [Паттерны файлов]
alwaysApply: [true/false]
---

# [Название]

[Содержание правила с примерами]

## Примеры из проекта

[Примеры кода из кодовой базы]

## Ссылки

- [Ссылка на связанное правило]
```

## Примеры генерации:

### Если найден PHP проект:

```markdown
---
name: PHP Laravel Rules
description: Правила для Laravel проекта
globs: ["**/*.php"]
alwaysApply: true
---

# PHP Laravel Правила

## Использование Eloquent

Всегда используй Eloquent ORM для работы с базой данных.

Пример:
```php
// ХОРОШО
$book = Book::where('title', $title)->first();

// ПЛОХО
$book = DB::select("SELECT * FROM books WHERE title = ?", [$title]);
```

## Service Layer

Используй Service Layer для бизнес-логики.

Пример:
```php
class BookService {
    public function getBookById(int $id): ?Book {
        return Book::find($id);
    }
}
```
```

### Если найден React проект:

```markdown
---
name: React Hooks Rules
description: Правила для React проекта с Hooks
globs: ["**/*.jsx", "**/*.tsx"]
alwaysApply: true
---

# React Hooks Правила

## Использование Hooks

Всегда используй функциональные компоненты с Hooks.

Пример:
```jsx
// ХОРОШО
function BookList() {
    const [books, setBooks] = useState([]);
    useEffect(() => {
        fetchBooks().then(setBooks);
    }, []);
    return <div>{books.map(book => <Book key={book.id} {...book} />)}</div>;
}

// ПЛОХО
class BookList extends Component {
    // ...
}
```
```

### Если найден PostgreSQL:

```markdown
---
name: PostgreSQL Security Rules
description: Правила безопасности для PostgreSQL
globs: ["**/*.sql", "**/*.php"]
alwaysApply: true
---

# PostgreSQL Безопасность

## Параметризованные запросы

НИКОГДА не используй прямую интерполяцию строк в SQL.

Пример:
```php
// ХОРОШО
$stmt = $pdo->prepare("SELECT * FROM books WHERE title = ?");
$stmt->execute([$title]);

// ПЛОХО
$query = "SELECT * FROM books WHERE title = '$title'";
$result = $pdo->query($query);
```
```

## Автоматический запуск:

Генератор правил должен запускаться:
- После анализа проекта (project-analyzer)
- При изменении технологического стека
- По запросу пользователя: "Сгенерируй правила для проекта"
- При обнаружении новых паттернов в коде

## Сохранение правил:

1. Сохраняй правила в `.cursor/rules/adaptive/`
2. Обновляй `.cursor/rules/rules-index.mdc`
3. Логируй изменения в `.cursor/config/adaptation-log.json`
