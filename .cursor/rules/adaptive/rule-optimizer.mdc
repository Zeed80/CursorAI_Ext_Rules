---
name: Rule Optimizer
description: Оптимизатор правил для удаления дубликатов и оптимизации контекста
globs: ["**/*"]
alwaysApply: false
---

# Оптимизатор правил

**Твоя роль**: Система оптимизации правил для удаления дубликатов и уменьшения контекста

## Процесс оптимизации:

### 1. Обнаружение дублирующихся правил

**Методы обнаружения**:

1. **Семантический анализ**:
   - Используй `codebase_search` для поиска похожих правил
   - Сравни содержание правил
   - Найди повторяющиеся концепции

2. **Анализ структуры**:
   - Сравни структуру правил
   - Найди идентичные примеры
   - Найди повторяющиеся объяснения

3. **Анализ зависимостей**:
   - Определи, какие правила ссылаются друг на друга
   - Найди циклические зависимости
   - Оптимизируй структуру ссылок

**Критерии дублирования**:
- Более 70% совпадения содержания
- Идентичные примеры кода
- Повторяющиеся концепции
- Одинаковые рекомендации

### 2. Объединение похожих правил

**Процесс объединения**:

1. **Выбери основное правило**:
   - Более полное и детальное
   - Более актуальное
   - Более часто используемое

2. **Объедини содержание**:
   - Сохрани уникальные части из обоих правил
   - Объедини примеры (оставь лучшие)
   - Сохрани важные детали

3. **Обнови ссылки**:
   - Обнови все ссылки на объединенное правило
   - Удали старое правило
   - Обнови индекс правил

**Пример объединения**:

**Правило 1** (3000 токенов):
```markdown
# Обработка ошибок PHP

[Детальное объяснение обработки ошибок в PHP]
```

**Правило 2** (2500 токенов):
```markdown
# Exception Handling

[Похожее объяснение обработки исключений]
```

**Объединенное правило** (3500 токенов):
```markdown
# Обработка ошибок и исключений

[Объединенное объяснение с лучшими примерами из обоих правил]
```

### 3. Оптимизация для уменьшения контекста

**Методы оптимизации**:

1. **Сжатие текста**:
   - Удали избыточные объяснения
   - Оставь только ключевые моменты
   - Используй краткие формулировки

2. **Оптимизация примеров**:
   - Оставь только лучшие примеры
   - Удали дублирующиеся примеры
   - Используй ссылки на дополнительные примеры

3. **Создание иерархии**:
   - Основные правила → полный текст
   - Детальные правила → ссылки
   - Примеры → отдельные файлы

4. **Использование ссылок**:
   - Ссылки на детальные объяснения
   - Ссылки на примеры
   - Ссылки на связанные правила

**Пример оптимизации**:

**До** (5000 токенов):
```markdown
# Детальное правило

## Введение
[Длинное введение]

## Концепция 1
[Детальное объяснение]
[Пример 1]
[Пример 2]
[Пример 3]

## Концепция 2
[Детальное объяснение]
[Пример 1]
[Пример 2]

## Заключение
[Длинное заключение]
```

**После** (2000 токенов):
```markdown
# Оптимизированное правило

## Ключевые концепции
[Краткое описание]

## Основной пример
[Лучший пример]

## Дополнительная информация
- [Детальное объяснение: detail.md]
- [Больше примеров: examples.md]
- [Связанные правила: related-rules.md]
```

### 4. Автоматическое обновление правил

**Триггеры обновления**:

1. **При изменении проекта**:
   - Изменение технологического стека
   - Добавление новых паттернов
   - Изменение архитектуры

2. **При обнаружении проблем**:
   - Правила не работают
   - Правила устарели
   - Правила противоречат друг другу

3. **Периодически**:
   - Раз в неделю для оптимизации
   - При превышении лимита контекста
   - По запросу пользователя

**Процесс обновления**:

1. Анализ текущих правил
2. Обнаружение проблем
3. Оптимизация
4. Валидация
5. Сохранение
6. Логирование изменений

## Алгоритм оптимизации:

### Шаг 1: Анализ

1. Прочитай все правила
2. Определи размер каждого правила
3. Найди дубликаты
4. Найди похожие правила
5. Определи приоритеты

### Шаг 2: Оптимизация

1. Объедини дубликаты
2. Сожми длинные правила
3. Создай иерархию
4. Оптимизируй ссылки

### Шаг 3: Валидация

1. Проверь, что смысл сохранен
2. Проверь, что примеры доступны
3. Проверь размер (не превышает лимит)
4. Проверь ссылки (работают ли)

### Шаг 4: Сохранение

1. Сохрани оптимизированные правила
2. Обнови индекс правил
3. Логируй изменения
4. Уведоми пользователя

## Критерии оптимизации:

### Максимальные размеры:

- Критичные правила: 3000 токенов
- Важные правила: 2000 токенов
- Справочные правила: 1000 токенов
- Примеры: сохранять полностью

### Приоритеты:

1. **Критичные** (не сжимать):
   - Правила безопасности
   - Правила обработки ошибок
   - Критичные паттерны проекта

2. **Важные** (сжимать умеренно):
   - Стандарты кода
   - Архитектурные паттерны

3. **Справочные** (сжимать агрессивно):
   - Детальные объяснения
   - Расширенные примеры

## Примеры оптимизации:

### Пример 1: Объединение правил безопасности

**До**:
- `sql-security.mdc` (2000 токенов)
- `database-security.mdc` (1800 токенов)
- `injection-prevention.mdc` (1500 токенов)

**После**:
- `database-security.mdc` (3000 токенов) - объединенное правило
- Ссылки на детальные разделы

### Пример 2: Оптимизация длинного правила

**До**: `error-handling.mdc` (5000 токенов)
**После**: `error-handling.mdc` (2000 токенов) + `error-handling-examples.md` (3000 токенов)

## Автоматический запуск:

Оптимизатор должен запускаться:
- При превышении лимита контекста (>100k токенов)
- При обнаружении дубликатов
- Периодически (раз в неделю)
- По запросу пользователя: "Оптимизируй правила"

## Логирование:

Сохраняй все изменения в `.cursor/config/adaptation-log.json`:

```json
{
  "adaptations": [
    {
      "date": "2024-01-15T10:00:00Z",
      "type": "optimization",
      "rules": ["rule1.mdc", "rule2.mdc"],
      "action": "merged",
      "sizeBefore": 5000,
      "sizeAfter": 3000,
      "savings": 2000
    }
  ]
}
```
